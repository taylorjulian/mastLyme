---
output: html_document
---

```{r paths}
papath <- '/Users/taylorminich/Documents/grad/mp/data/plants/abundance/'
sppath <- '/Users/taylorminich/Documents/grad/mp/data/seeds/processed/'
spath <- '/Users/taylorminich/Documents/grad/mp/data/seeds/'
cppath <- '/Users/taylorminich/Documents/grad/mp/data/covariates/processed/'
```

```{r calculate site climate GEE}
sites <- c('BART', 'BLAN', 'GRSM', 'HARV', 'OSBS', 'SCBI', 'SERC')

cov <- read.csv(paste0(cppath, 'cov.csv')) %>%
  mutate(def = ppt - pet)

def <- cov %>%
  mutate(siteID = substr(plotID, 1, 4)) %>%
  filter(siteID %in% sites) %>%
  filter(month(date) < 9 & month(date) > 5) %>%
  group_by(plotID, year(date)) %>%
  summarise(def = sum(def)) %>%
  group_by(plotID) %>%
  mutate(defSite = mean(def)) %>%
  mutate(defAnomaly = def - defSite) %>%
  rename(year = 'year(date)')

tmin <- cov %>%
  mutate(siteID = substr(plotID, 1, 4)) %>%
  filter(siteID %in% sites) %>%
  filter(month(date) > 11 | month(date) < 4) %>%
  group_by(plotID, year(date)) %>%
  summarise(tmin = sum(tmin)) %>%
  mutate(winterTminSite = min(tmin)) %>%
  mutate(winterTminAnomaly = tmin - winterTminSite)%>%
  rename(year = 'year(date)')

inputs <- def %>%
  left_join(tmin, by = c('plotID', 'year')) %>%
  select(-def, -tmin)

```

```{r calculate site climate unix}
def <- read.csv(paste0(cppath, 'def.csv')) %>%
  filter(month(date) < 9 & month(date) > 5) %>%
  group_by(siteID, year(date)) %>%
  summarise(def = sum(def)) %>%
  group_by(siteID) %>%
  mutate(defSite = mean(def)) %>%
  mutate(defAnomaly = def - defSite) %>%
  rename(year = 'year(date)') %>%
  mutate(year = year - 1) 
  
winterTminSite <- read.csv(paste0(cppath, 'tmin.csv')) %>%
  filter(month(date) > 11 | month(date) < 4) %>%
  mutate(year = if_else(month(date) == 12, year(date) + 1, year(date))) %>%
  group_by(siteID, year) %>%
  summarise(tmin = min(tmin)) %>%
  group_by(siteID) %>%
  summarise(winterTminSite = mean(tmin))

tmin <- read.csv(paste0(cppath, 'tmin.csv')) %>%
  filter(month(date) > 11 | month(date) < 4) %>%
  mutate(year = if_else(month(date) == 12, year(date) + 1, year(date))) %>%
  group_by(siteID, year) %>%
  summarise(tmin = min(tmin)) %>% 
  left_join(winterTminSite) %>%
  mutate(winterTminAnomaly = tmin - winterTminSite)

inputs <- def %>%
  left_join(tmin, by = c('siteID', 'year'))

```

```{r calculate mast}
params <- read.csv(paste0(sppath, 'params.csv'))

mast <- read.csv(paste0(papath, 'tree.csv')) %>%
  select(-year) %>%
  left_join(inputs, by = c('siteID')) %>%
  mutate(code = recode_factor(code, `querGemi` = 'querRubr', `querHemi` = 'querRubr', `querLaev` = 'querRubr', `querMont` = 'querAlba',
                             `querMueh` = 'querAlba', `querNigr` = 'querRubr', `querUNKN` = 'querRubr',`querVirg` = 'querRubr', 
                             `pinuElli` = 'pinuPalu', `pinuPung` = 'pinuTaed', `pinuRube` = 'pinuTaed', `pinuUNKN` = 'pinuTaed', 
                             `piceAbie` = 'piceGlau', `piceUNKN` = 'piceGlau', `oxydUNKN` = 'oxydArbo', `nyssBifl` = 'nyssSylv',
                             `ilexCass` = 'ilexOpac', `ilexCori` = 'ilexOpac', `ilexGlab` = 'ilexOpac', `ilexMucr` = 'ilexOpac', 
                             `cornUNKN` = 'cornFlor', `betuNigr` = 'betuLent', `betuPopu` = 'betuLent')) %>%
  left_join(params, by = 'code') %>%
  filter(year > 2012) %>%
  na.omit() %>%
  mutate(mast = intercept + diam_beta*stemDiameter + diamSq_beta*(stemDiameter^2) + defAnomaly_beta*defAnomaly + defSite_beta*defSite +
           winterTminSite_beta*winterTminSite + defSiteWinterTminSite_beta*defSite*winterTminSite) %>%
  select(plotID, siteID, year, code, genus, mast)

write.csv(mast, file = paste0(spath, 'mast.csv'), row.names = FALSE)
```