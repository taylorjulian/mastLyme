---
output: html_document
---

```{r paths}
papath <- '/Users/taylorminich/Documents/grad/mp/data/plants/abundance/'
sppath <- '/Users/taylorminich/Documents/grad/mp/data/seeds/processed/'
spath <- '/Users/taylorminich/Documents/grad/mp/data/seeds/'
cppath <- '/Users/taylorminich/Documents/grad/mp/data/covariates/processed/'
```

```{r calculate site climate GEE}
sites <- c('BART', 'BLAN', 'GRSM', 'HARV', 'SCBI', 'SERC')

cov <- read.csv(paste0(cppath, 'cov.csv')) %>%
  mutate(def = ppt - pet)

def <- cov %>%
  mutate(siteID = substr(plotID, 1, 4)) %>%
  filter(siteID %in% sites) %>%
  filter(month(date) < 9 & month(date) > 5) %>%
  group_by(plotID, year(date), siteID) %>%
  summarise(def = sum(def)) %>%
  group_by(plotID) %>%
  mutate(defSite = mean(def)) %>%
  mutate(defAnomaly = def - defSite) %>%
  rename(year = 'year(date)') %>%
  select(-def)

tmin <- cov %>%
  mutate(siteID = substr(plotID, 1, 4)) %>%
  filter(siteID %in% sites) %>%
  filter(month(date) > 11 | month(date) < 4) %>%
  group_by(plotID, year(date), siteID) %>%
  mutate(winterTminSite = min(tmin)) %>%
  rename(year = 'year(date)') %>%
  select(plotID, siteID, year, winterTminSite) %>%
  distinct()

inputs <- def %>%
  left_join(tmin, by = c('plotID', 'year', 'siteID')) 

```

```{r calculate site climate unix}
def <- read.csv(paste0(cppath, 'def.csv')) %>%
  filter(month(date) < 9 & month(date) > 5) %>%
  group_by(siteID, year(date)) %>%
  summarise(def = sum(def)) %>%
  group_by(siteID) %>%
  mutate(defSite = mean(def)) %>%
  mutate(defAnomaly = def - defSite) %>%
  rename(year = 'year(date)') 
  
winterTminSite <- read.csv(paste0(cppath, 'tmin.csv')) %>%
  filter(month(date) > 11 | month(date) < 4) %>%
  mutate(year = if_else(month(date) == 12, year(date) + 1, year(date))) %>%
  group_by(siteID, year) %>%
  summarise(tmin = min(tmin)) %>%
  group_by(siteID) %>%
  summarise(winterTminSite = mean(tmin))

tmin <- read.csv(paste0(cppath, 'tmin.csv')) %>%
  filter(month(date) > 11 | month(date) < 4) %>%
  mutate(year = if_else(month(date) == 12, year(date) + 1, year(date))) %>%
  group_by(siteID, year) %>%
  summarise(tmin = min(tmin)) %>% 
  left_join(winterTminSite) %>%
  mutate(winterTminAnomaly = tmin - winterTminSite)

inputs <- def %>%
  left_join(tmin, by = c('siteID', 'year'))

```

```{r calculate mast}
fecParams <- read.csv(paste0(sppath, 'fecParams.csv'))
repParams <- read.csv(paste0(sppath, 'repParams.csv'))
nutrition <- read.csv(paste0(spath, 'nutrition.csv'))

genera <- c('Acer', 'Betula', 'Carya', 'Cornus', 'Fagus', 'Fraxinus', 'Ilex', 
                    'Liriodendron', 'Nyssa', 'Oxydendrum', 'Picea', 'Pinus', 'Quercus', 'Tsuga')

mast <- read.csv(paste0(papath, 'tree.csv')) %>%
  filter(genus %in% genera) %>%
  mutate(code = recode_factor(code, `acerSac2` = 'acerUNKN')) %>%
  left_join(inputs, by = c('siteID')) %>%
  na.omit() %>%
  mutate(code = recode_factor(code, `querGemi` = 'querRubr', `querHemi` = 'querRubr', `querLaev` = 'querRubr', `querMont` = 'querAlba',
                             `querMueh` = 'querAlba', `querNigr` = 'querRubr', `querUNKN` = 'querRubr',`querVirg` = 'querRubr', 
                             `pinuElli` = 'pinuPalu', `pinuPung` = 'pinuTaed', `pinuRube` = 'pinuTaed', `pinuUNKN` = 'pinuTaed', 
                             `piceAbie` = 'piceGlau', `piceUNKN` = 'piceGlau', `oxydUNKN` = 'oxydArbo', `nyssBifl` = 'nyssSylv',
                             `ilexCass` = 'ilexOpac', `ilexCori` = 'ilexOpac', `ilexGlab` = 'ilexOpac', `ilexMucr` = 'ilexOpac', 
                             `cornUNKN` = 'cornFlor', `caryGlab` = 'caryOval', `betuNigr` = 'betuLent', `betuPopu` = 'betuLent')) %>%
  left_join(fecParams, by = 'code') %>%
  left_join(repParams, by = 'code') %>%
  mutate(mast = exp(interceptRep + diam_betaRep*stemDiameter)*exp(interceptFec + diam_betaFec*stemDiameter + diamSq_beta*(stemDiameter^2) + defAnomaly_beta*defAnomaly + defSite_beta*defSite + winterTminSite_beta*winterTminSite + defSiteWinterTminSite_beta*defSite*winterTminSite)) %>%
  select(plotID, siteID, year, code, genus, mast)

write.csv(mast, file = paste0(spath, 'mast.csv'), row.names = FALSE)
```